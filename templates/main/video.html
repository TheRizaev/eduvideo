{% extends 'main/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ video.title }} - KRONIK{% endblock %}

{% block head_extras %}
<!-- –û—Å–Ω–æ–≤–Ω–æ–π –ø–ª–µ–µ—Ä -->
<link href="https://vjs.zencdn.net/7.20.3/video-js.css" rel="stylesheet" />
<script src="https://vjs.zencdn.net/7.20.3/video.min.js"></script>

<!-- –ü–ª–∞–≥–∏–Ω—ã –¥–ª—è –≤–∏–¥–µ–æ–ø–ª–µ–µ—Ä–∞ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/videojs-contrib-quality-levels/2.1.0/videojs-contrib-quality-levels.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/videojs-http-source-selector/1.1.6/videojs-http-source-selector.min.js"></script>

<!-- –ù–∞—à –∫–∞—Å—Ç–æ–º–Ω—ã–π –ø–ª–µ–µ—Ä -->
<script src="{% static 'js/video-player.js' %}"></script>
{% endblock %}

{% block content %}
<div class="video-page-layout">
    <div class="video-content">
        <div class="video-player-container">
            <div class="video-player">
                <video
                    id="kronik-player"
                    class="video-js vjs-big-play-centered vjs-theme-kronik"
                    controls
                    preload="auto"
                    poster="{% if video.thumbnail %}{{ video.thumbnail.url }}{% else %}{% static 'placeholder.jpg' %}{% endif %}"
                    data-setup="{}"
                >
                    <!-- –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥—É—Ç —Ä–∞–∑–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–∞—á–µ—Å—Ç–≤ -->
                    <source src="{{ video.video_file.url|default:'#' }}" type="video/mp4" label="720p" />
                    <source src="{{ video.video_file.url|default:'#' }}" type="video/mp4" label="480p" />
                    <source src="{{ video.video_file.url|default:'#' }}" type="video/mp4" label="360p" />
                    
                    <p class="vjs-no-js">
                        –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤–∏–¥–µ–æ –≤–∫–ª—é—á–∏—Ç–µ JavaScript –∏ –æ–±–Ω–æ–≤–∏—Ç–µ –±—Ä–∞—É–∑–µ—Ä –¥–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–≥–æ HTML5 –≤–∏–¥–µ–æ.
                    </p>
                </video>
            </div>
            
            <div class="video-details">
                <h1>{{ video.title }}</h1>
                <div class="video-info-bar">
                    <div class="views-info">{{ video.views }} ‚Ä¢ {{ video.age }}</div>
                    <div class="actions-bar">
                        <button class="action-button" id="likeButton">üëç <span id="likeCount">0</span></button>
                        <button class="action-button" id="dislikeButton">üëé <span id="dislikeCount">0</span></button>
                        <button class="action-button">‚ÜóÔ∏è –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
                        <button class="action-button">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>
                </div>
                
                <div class="channel-info">
                    <div class="channel-avatar">{{ video.channel|first }}</div>
                    <div class="channel-details">
                        <div class="channel-name">{{ video.channel }}</div>
                        <div class="subscribers">10K –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</div>
                    </div>
                    <button class="subscribe-button">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</button>
                </div>
                
                <div class="video-description">
                    <p>{{ video.description|default:"–û–ø–∏—Å–∞–Ω–∏–µ –≤–∏–¥–µ–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç." }}</p>
                </div>
            </div>
            
            <div class="comments-section">
                <h2>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h2>
                <div class="comment-form">
                    <div class="user-avatar">{% if user.is_authenticated %}{{ user.username|first }}{% else %}–ì{% endif %}</div>
                    <input type="text" placeholder="{% if user.is_authenticated %}–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...{% else %}–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å{% endif %}" {% if not user.is_authenticated %}disabled{% endif %}>
                </div>
                
                <div class="comments-list">
                    {% if comments %}
                        {% for comment in comments %}
                        <div class="comment">
                            <div class="comment-avatar">{{ comment.user.username|first }}</div>
                            <div class="comment-content">
                                <div class="comment-author">{{ comment.user.username }}</div>
                                <div class="comment-text">{{ comment.content }}</div>
                                <div class="comment-meta">{{ comment.created_at|naturaltime }}</div>
                                <div class="comment-actions">
                                    <button class="comment-like">üëç <span>{{ comment.likes|default:"0" }}</span></button>
                                    <button class="comment-dislike">üëé</button>
                                    <button class="comment-reply">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
                                </div>
                                
                                {% if comment.replies.exists %}
                                <div class="comment-replies">
                                    {% for reply in comment.replies.all %}
                                    <div class="reply">
                                        <div class="comment-avatar">{{ reply.user.username|first }}</div>
                                        <div class="comment-content">
                                            <div class="comment-author">{{ reply.user.username }}</div>
                                            <div class="comment-text">{{ reply.content }}</div>
                                            <div class="comment-meta">{{ reply.created_at|naturaltime }}</div>
                                            <div class="comment-actions">
                                                <button class="comment-like">üëç <span>{{ reply.likes|default:"0" }}</span></button>
                                                <button class="comment-dislike">üëé</button>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="comment">
                            <div class="comment-avatar">–ö</div>
                            <div class="comment-content">
                                <div class="comment-author">–ö–æ–º–º–µ–Ω—Ç–∞—Ç–æ—Ä</div>
                                <div class="comment-text">–û—á–µ–Ω—å –ø–æ–ª–µ–∑–Ω–æ–µ –≤–∏–¥–µ–æ! –°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ.</div>
                                <div class="comment-meta">2 –¥–Ω—è –Ω–∞–∑–∞–¥</div>
                                <div class="comment-actions">
                                    <button class="comment-like">üëç <span>24</span></button>
                                    <button class="comment-dislike">üëé</button>
                                    <button class="comment-reply">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="related-videos">
        <h3>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –≤–∏–¥–µ–æ</h3>
        <div class="related-videos-list" id="related-videos-container">
            <!-- –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –≤–∏–¥–µ–æ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —Å –ø–æ–º–æ—â—å—é JavaScript -->
        </div>
    </div>
</div>

<!-- –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—É—é –ø–∞–Ω–µ–ª—å –æ –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à–∞—Ö -->
<div class="keyboard-shortcuts-info">
    <button class="shortcuts-toggle">‚å®Ô∏è –ü–æ–∫–∞–∑–∞—Ç—å –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏</button>
    <div class="shortcuts-panel" style="display: none;">
        <h3>–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏</h3>
        <ul>
            <li><span class="key">–ü—Ä–æ–±–µ–ª</span> - –ü–∞—É–∑–∞/–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ</li>
            <li><span class="key">‚Üí</span> - –ü–µ—Ä–µ–º–æ—Ç–∫–∞ –≤–ø–µ—Ä–µ–¥ –Ω–∞ 10 —Å–µ–∫</li>
            <li><span class="key">‚Üê</span> - –ü–µ—Ä–µ–º–æ—Ç–∫–∞ –Ω–∞–∑–∞–¥ –Ω–∞ 10 —Å–µ–∫</li>
            <li><span class="key">‚Üë</span> - –£–≤–µ–ª–∏—á–∏—Ç—å –≥—Ä–æ–º–∫–æ—Å—Ç—å</li>
            <li><span class="key">‚Üì</span> - –£–º–µ–Ω—å—à–∏—Ç—å –≥—Ä–æ–º–∫–æ—Å—Ç—å</li>
            <li><span class="key">F</span> - –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º</li>
            <li><span class="key">M</span> - –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∑–≤—É–∫–∞</li>
            <li><span class="key">0-9</span> - –ü–µ—Ä–µ—Ö–æ–¥ –∫ % –≤–∏–¥–µ–æ (0 = –Ω–∞—á–∞–ª–æ, 5 = 50%, 9 = 90%)</li>
        </ul>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞—à–µ–≥–æ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ø–ª–µ–µ—Ä–∞
        const player = new KronikPlayer('kronik-player', {
            videoId: '{{ video.id }}',
            showNextVideo: true,
            nextVideoSelector: '.related-video-card:first-child',
            nextTitleSelector: '.related-title',
            nextChannelSelector: '.related-channel',
            trackWatchProgress: true,
            trackWatchComplete: true
        });
        
        // –ü–∞–Ω–µ–ª—å –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à
        document.querySelector('.shortcuts-toggle').addEventListener('click', function() {
            const panel = document.querySelector('.shortcuts-panel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                this.textContent = '‚å®Ô∏è –°–∫—Ä—ã—Ç—å –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏';
            } else {
                panel.style.display = 'none';
                this.textContent = '‚å®Ô∏è –ü–æ–∫–∞–∑–∞—Ç—å –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏';
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª–∞–π–∫–æ–≤ –∏ –¥–∏–∑–ª–∞–π–∫–æ–≤
        const likeButton = document.getElementById('likeButton');
        const dislikeButton = document.getElementById('dislikeButton');
        const likeCount = document.getElementById('likeCount');
        const dislikeCount = document.getElementById('dislikeCount');
        
        if (likeButton && dislikeButton) {
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –ø–æ—Å—Ç–∞–≤–ª–µ–Ω –ª–∏ –ª–∞–π–∫/–¥–∏—Å–ª–∞–π–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
            function loadReactions() {
                const videoLikes = localStorage.getItem('kronik-video-likes') || '{}';
                const videoLikesObj = JSON.parse(videoLikes);
                
                const videoId = '{{ video.id }}';
                const reaction = videoLikesObj[videoId];
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
                likeButton.classList.remove('active');
                dislikeButton.classList.remove('active');
                
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–ª, –æ—Ç–º–µ—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
                if (reaction === 'like') {
                    likeButton.classList.add('active');
                } else if (reaction === 'dislike') {
                    dislikeButton.classList.add('active');
                }
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            loadReactions();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞–∂–∞—Ç–∏–π
            likeButton.addEventListener('click', function() {
                if (!likeButton.classList.contains('active')) {
                    // –î–æ–±–∞–≤–ª—è–µ–º –ª–∞–π–∫
                    likeButton.classList.add('active');
                    dislikeButton.classList.remove('active');
                    
                    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
                    let likes = parseInt(likeCount.textContent) || 0;
                    likeCount.textContent = likes + 1;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∞–∫—Ü–∏—é
                    saveReaction('like');
                    
                    // API –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–≤ –±—É–¥—É—â–µ–º)
                    // sendReaction('like');
                } else {
                    // –£–±–∏—Ä–∞–µ–º –ª–∞–π–∫
                    likeButton.classList.remove('active');
                    
                    // –£–º–µ–Ω—å—à–∞–µ–º —Å—á–µ—Ç—á–∏–∫
                    let likes = parseInt(likeCount.textContent) || 0;
                    if (likes > 0) likeCount.textContent = likes - 1;
                    
                    // –£–¥–∞–ª—è–µ–º —Ä–µ–∞–∫—Ü–∏—é
                    removeReaction();
                    
                    // API –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–≤ –±—É–¥—É—â–µ–º)
                    // removeReactionRequest();
                }
            });
            
            dislikeButton.addEventListener('click', function() {
                if (!dislikeButton.classList.contains('active')) {
                    // –î–æ–±–∞–≤–ª—è–µ–º –¥–∏–∑–ª–∞–π–∫
                    dislikeButton.classList.add('active');
                    likeButton.classList.remove('active');
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∞–∫—Ü–∏—é
                    saveReaction('dislike');
                    
                    // API –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–≤ –±—É–¥—É—â–µ–º)
                    // sendReaction('dislike');
                } else {
                    // –£–±–∏—Ä–∞–µ–º –¥–∏–∑–ª–∞–π–∫
                    dislikeButton.classList.remove('active');
                    
                    // –£–¥–∞–ª—è–µ–º —Ä–µ–∞–∫—Ü–∏—é
                    removeReaction();
                    
                    // API –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–≤ –±—É–¥—É—â–µ–º)
                    // removeReactionRequest();
                }
            });
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∞–∫—Ü–∏–∏ –≤ localStorage
            function saveReaction(reactionType) {
                const videoLikes = localStorage.getItem('kronik-video-likes') || '{}';
                const videoLikesObj = JSON.parse(videoLikes);
                
                const videoId = '{{ video.id }}';
                videoLikesObj[videoId] = reactionType;
                
                localStorage.setItem('kronik-video-likes', JSON.stringify(videoLikesObj));
            }
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ä–µ–∞–∫—Ü–∏–∏
            function removeReaction() {
                const videoLikes = localStorage.getItem('kronik-video-likes') || '{}';
                const videoLikesObj = JSON.parse(videoLikes);
                
                const videoId = '{{ video.id }}';
                delete videoLikesObj[videoId];
                
                localStorage.setItem('kronik-video-likes', JSON.stringify(videoLikesObj));
            }
        }
        
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π ID –≤–∏–¥–µ–æ –∏–∑ URL
        const currentPath = window.location.pathname;
        const currentVideoId = parseInt(currentPath.split('/').filter(Boolean)[1]);
        
        // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã—Ö –≤–∏–¥–µ–æ
        const relatedVideosContainer = document.getElementById('related-videos-container');
        
        // –°–æ–∑–¥–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –≤–∏–¥–µ–æ, –∏—Å–∫–ª—é—á–∞—è —Ç–µ–∫—É—â–µ–µ
        if (relatedVideosContainer && window.videoData) {
            // –§–∏–ª—å—Ç—Ä—É–µ–º –≤–∏–¥–µ–æ, –∏—Å–∫–ª—é—á–∞—è —Ç–µ–∫—É—â–µ–µ
            const relatedVideos = window.videoData.filter(video => video.id !== currentVideoId);
            
            // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 5 –≤–∏–¥–µ–æ –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
            const recommendedVideos = relatedVideos.slice(0, 5);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–∂–¥–æ–µ –≤–∏–¥–µ–æ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            recommendedVideos.forEach(video => {
                const videoElement = document.createElement('div');
                videoElement.className = 'related-video-card';
                videoElement.onclick = function() {
                    window.location.href = `/video/${video.id}/`;
                };
                
                videoElement.innerHTML = `
                    <div class="related-thumbnail">
                        <img src="/static/previews/${video.id}.jpg" onerror="this.src='/static/placeholder.jpg'" alt="${video.title}">
                        <div class="duration">${video.duration}</div>
                    </div>
                    <div class="related-info">
                        <div class="related-title">${video.title}</div>
                        <div class="related-channel">${video.channel}</div>
                        <div class="related-stats">${video.views} ‚Ä¢ ${video.age}</div>
                    </div>
                `;
                
                relatedVideosContainer.appendChild(videoElement);
            });
        }
    });
</script>
{% endblock %}